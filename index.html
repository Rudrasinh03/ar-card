<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AR Card</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body,html{margin:0;height:100%;font-family:Poppins,Arial;background:transparent}
    #status{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border-radius:10px;z-index:9999}
    /* Reveal overlay */
    #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:10000}
    #card{width:360px;max-width:92%;background:linear-gradient(135deg,#fff7e6,#fff1cc);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.45);padding:22px;text-align:center;position:relative}
    #card h2{margin:0 0 8px;color:#222;font-size:22px}
    #card p.sub{margin:0 0 12px;color:#444}
    #scratchCanvas{width:100%;height:140px;border-radius:12px;background:#c7b37a;display:block;cursor:crosshair}
    #revealText{margin-top:14px;font-weight:700;color:#2b2b2b;font-size:20px}
    #closeBtn{position:absolute;top:10px;right:10px;background:transparent;border:none;font-size:18px;cursor:pointer}
    #toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.75);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:10001}
  </style>
</head>
<body>
  <div id="status">ðŸ“· Initializing camera...</div>
  <div id="overlay" aria-hidden="true">
    <div id="card">
      <button id="closeBtn" title="Close">âœ•</button>
      <h2>ðŸŽ‰ You unlocked a reward!</h2>
      <p class="sub">Scratch the silver area to reveal your offer</p>
      <canvas id="scratchCanvas"></canvas>
      <div id="revealText"></div>
    </div>
  </div>
  <div id="toast"></div>

  <a-scene mindar-image="imageTargetSrc: targets (1).mind; autoStart:true" embedded vr-mode-ui="enabled:false">
    <a-assets>
      <video id="myVideo" src="thank_you.mp4" playsinline preload="auto" crossorigin="anonymous"></video>
    </a-assets>
    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity mindar-image-target="targetIndex:0">
      <a-video id="videoPlane" src="#myVideo" width="1" height="0.56" visible="false" material="shader:flat"></a-video>
    </a-entity>
  </a-scene>

<script>
  // read params
  const params = new URLSearchParams(window.location.search);
  const card = params.get('id') || '';
  const isFirst = params.get('isFirst') === 'true';
  const discount = decodeURIComponent(params.get('discount') || '');

  const status = document.getElementById('status');
  const video = document.getElementById('myVideo');
  const plane = document.getElementById('videoPlane');

  const overlay = document.getElementById('overlay');
  const scratchCanvas = document.getElementById('scratchCanvas');
  const revealText = document.getElementById('revealText');
  const closeBtn = document.getElementById('closeBtn');
  const toast = document.getElementById('toast');

  // AR events
  document.querySelector('a-scene').addEventListener('arReady', ()=> status.innerText='âœ… Point camera at target');
  document.querySelector('a-scene').addEventListener('targetFound', async ()=>{
    status.innerText='ðŸŽ¬ Target found â€” playing video';
    plane.setAttribute('visible', true);
    try{ await video.play(); }catch(e){}
  });
  document.querySelector('a-scene').addEventListener('targetLost', ()=>{
    status.innerText='ðŸ“· Hold steady to keep AR visible';
    video.pause();
    plane.setAttribute('visible', false);
  });

  // scratch setup helpers
  let ctx, scratching=false, revealed=false;
  function initScratch(){
    const rect = scratchCanvas.getBoundingClientRect();
    scratchCanvas.width = Math.max(300, rect.width*devicePixelRatio);
    scratchCanvas.height = Math.max(140, rect.height*devicePixelRatio);
    // scale canvas visually
    scratchCanvas.style.width = '100%';
    scratchCanvas.style.height = '140px';
    ctx = scratchCanvas.getContext('2d');
    // draw metallic overlay
    ctx.globalCompositeOperation = 'source-over';
    const grad = ctx.createLinearGradient(0,0,scratchCanvas.width,scratchCanvas.height);
    grad.addColorStop(0,'#bdbdbd'); grad.addColorStop(0.5,'#e6e6e6'); grad.addColorStop(1,'#b0a090');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,scratchCanvas.width,scratchCanvas.height);
    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.font = `${Math.floor(24*devicePixelRatio)}px Poppins`;
    ctx.textAlign = "center";
    ctx.fillText("Scratch to reveal", scratchCanvas.width/2, scratchCanvas.height/2 + 8*devicePixelRatio);
  }

  function scratchAt(x,y){
    if(!ctx) return;
    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x*devicePixelRatio, y*devicePixelRatio, 28*devicePixelRatio, 0, Math.PI*2);
    ctx.fill();
  }

  ['pointerdown','touchstart','mousedown'].forEach(ev => {
    scratchCanvas.addEventListener(ev, ()=> scratching=true);
  });
  ['pointerup','touchend','mouseup','mouseleave'].forEach(ev => {
    scratchCanvas.addEventListener(ev, ()=> scratching=false);
  });
  scratchCanvas.addEventListener('pointermove', function(e){
    if(!scratching) return;
    const rect = scratchCanvas.getBoundingClientRect();
    const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
    const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
    scratchAt(x,y);
  });

  scratchCanvas.addEventListener('pointerup', function(){
    if(revealed) return;
    revealed = true;
    // reveal text and confetti
    overlay.style.display = 'none';
    revealMessageAndConfetti();
  });

  closeBtn.addEventListener('click', ()=> overlay.style.display='none');

  function revealMessageAndConfetti(){
    const text = discount ? `ðŸŽŠ You unlocked ${discount} OFF!` : 'ðŸŽŠ You unlocked a reward!';
    toast.innerText = text;
    toast.style.display = 'block';
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }});
    setTimeout(()=> toast.style.display='none', 5000);
  }

  // When video ends: show scratch only if first scan; else small toast
  video.addEventListener('ended', ()=>{
    if(isFirst){
      // show overlay and init scratch
      overlay.style.display = 'flex';
      // small delay to ensure canvas has layout
      setTimeout(()=> initScratch(), 120);
      // overlay aria visible
    } else {
      // small toast
      toast.innerText = "ðŸ‘‹ Welcome back â€” only AR video is shown.";
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 2200);
    }
  });

  // If users land here and want to debug: log params
  console.log({card,isFirst,discount});
</script>
</body>
</html>
