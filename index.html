<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AR Reward Experience</title>

  <!-- A-Frame + MindAR + Confetti -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body,html{
      margin:0;
      height:100%;
      font-family:'Poppins',sans-serif;
      background:transparent;
      overflow:hidden;
      touch-action:none;
    }

    #status{
      position:fixed;
      bottom:15px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.7);
      color:#FFD700;
      padding:8px 14px;
      border-radius:10px;
      font-size:14px;
      z-index:9999;
      box-shadow:0 0 10px rgba(255,215,0,0.4);
      backdrop-filter:blur(10px);
      animation:fadeIn 0.5s ease;
    }

    /* Premium overlay (closes camera view) */
    #overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.95);
      z-index:10000;
      animation:fadeIn 0.4s ease;
      flex-direction:column;
    }

    /* Premium scratch card box */
    #card{
      width:360px;
      max-width:90%;
      border-radius:20px;
      background:rgba(15,15,15,0.9);
      border:1px solid rgba(255,215,0,0.3);
      box-shadow:0 0 25px rgba(255,215,0,0.2), inset 0 0 15px rgba(255,215,0,0.1);
      padding:26px;
      text-align:center;
      color:#fff;
      backdrop-filter:blur(14px);
      animation:popUp 0.4s ease;
    }

    #card h2{
      font-size:22px;
      margin:0 0 8px;
      background:linear-gradient(90deg,#FFD700,#FFF3B0);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    #card p.sub{
      font-size:14px;
      color:#ccc;
      margin:0 0 16px;
    }

    #scratchCanvas{
      width:100%;
      height:150px;
      border-radius:14px;
      display:block;
      cursor:crosshair;
      touch-action:none;
      box-shadow:inset 0 0 20px rgba(255,215,0,0.2);
    }

    #closeBtn{
      position:absolute;
      top:10px;
      right:12px;
      background:none;
      border:none;
      font-size:22px;
      cursor:pointer;
      color:#FFD700;
    }

    /* Toast (Gold shimmer) */
    #toast{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:#FFD700;
      padding:12px 20px;
      border-radius:12px;
      display:none;
      font-size:14px;
      z-index:10001;
      box-shadow:0 0 20px rgba(255,215,0,0.4);
      backdrop-filter:blur(8px);
      animation:fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from{opacity:0;} to{opacity:1;}
    }
    @keyframes popUp {
      0%{transform:scale(0.9);opacity:0;}
      100%{transform:scale(1);opacity:1;}
    }
  </style>
</head>
<body>
  <div id="status">üì∑ Initializing camera...</div>

  <div id="overlay">
    <div id="card">
      <button id="closeBtn">‚úï</button>
      <h2>üéÅ Luxury Reward Unlocked!</h2>
      <p class="sub">Scratch the gold foil to reveal your offer</p>
      <canvas id="scratchCanvas"></canvas>
    </div>
  </div>

  <div id="toast"></div>

  <!-- AR Scene -->
  <a-scene mindar-image="imageTargetSrc: targets (1).mind; autoStart:true" embedded vr-mode-ui="enabled:false">
    <a-assets>
      <video id="myVideo" src="thank_you.mp4" playsinline preload="auto" crossorigin="anonymous"></video>
    </a-assets>
    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity mindar-image-target="targetIndex:0">
      <a-video id="videoPlane" src="#myVideo" width="1" height="0.56" visible="false" material="shader:flat; opacity:0;"></a-video>
    </a-entity>
  </a-scene>

<script>
const params = new URLSearchParams(window.location.search);
const card = params.get('id') || '';
const isFirst = params.get('isFirst') === 'true';
const discount = decodeURIComponent(params.get('discount') || '');

const status = document.getElementById('status');
const video = document.getElementById('myVideo');
const plane = document.getElementById('videoPlane');
const overlay = document.getElementById('overlay');
const scratchCanvas = document.getElementById('scratchCanvas');
const closeBtn = document.getElementById('closeBtn');
const toast = document.getElementById('toast');

document.querySelector('a-scene').addEventListener('arReady', ()=> {
  status.innerText='‚úÖ Ready ‚Äî point your camera at your card';
});
document.querySelector('a-scene').addEventListener('targetFound', async ()=>{
  status.innerText='üé¨ Target found ‚Äî video playing';
  plane.setAttribute('visible', true);
  plane.setAttribute('material','shader:flat; opacity:1;');
  try{ await video.play(); }catch(e){}
});
document.querySelector('a-scene').addEventListener('targetLost', ()=>{
  status.innerText='üì∑ Hold steady to keep AR visible';
  video.pause();
  plane.setAttribute('material','shader:flat; opacity:0;');
  plane.setAttribute('visible', false);
});

let ctx, scratching=false;
function initScratch(){
  const rect = scratchCanvas.getBoundingClientRect();
  scratchCanvas.width = rect.width * devicePixelRatio;
  scratchCanvas.height = 150 * devicePixelRatio;
  ctx = scratchCanvas.getContext('2d');

  // GOLD metallic gradient
  const grad = ctx.createLinearGradient(0,0,scratchCanvas.width,scratchCanvas.height);
  grad.addColorStop(0,'#7a6020');
  grad.addColorStop(0.3,'#b49438');
  grad.addColorStop(0.6,'#fce79b');
  grad.addColorStop(1,'#b49438');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,scratchCanvas.width,scratchCanvas.height);

  ctx.font = `${26*devicePixelRatio}px Poppins`;
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.textAlign = 'center';
  ctx.fillText('Scratch Here', scratchCanvas.width/2, scratchCanvas.height/2 + 10);
}

function scratchAt(x,y){
  ctx.globalCompositeOperation='destination-out';
  ctx.beginPath();
  ctx.arc(x*devicePixelRatio, y*devicePixelRatio, 30*devicePixelRatio, 0, Math.PI*2);
  ctx.fill();
}

// smoother touch (no screen shake)
scratchCanvas.addEventListener('pointerdown',e=>{
  e.preventDefault();
  scratching=true;
});
scratchCanvas.addEventListener('pointerup',e=>{
  e.preventDefault();
  scratching=false;
});
scratchCanvas.addEventListener('pointermove',e=>{
  if(!scratching) return;
  const rect=scratchCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  scratchAt(x,y);
});
closeBtn.addEventListener('click',()=> overlay.style.display='none');

video.addEventListener('ended',()=>{
  if(isFirst){
    // hide AR background
    document.querySelector('a-scene').style.display='none';
    overlay.style.display='flex';
    setTimeout(()=> initScratch(),200);
  }else{
    showToast('üëã Welcome back ‚Äî AR video only this time.');
  }
});

function showToast(msg){
  toast.innerText=msg;
  toast.style.display='block';
  setTimeout(()=> toast.style.display='none',2500);
}

// Reveal discount
scratchCanvas.addEventListener('pointerup',()=>{
  overlay.style.display='none';
  confetti({
    particleCount: 120,
    spread: 70,
    origin:{y:0.7},
    colors:['#FFD700','#FFF3B0','#FFDF00']
  });
  showToast(`üéâ You unlocked ${discount || 'your reward'}!`);
});
</script>
</body>
</html>
