<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AR Reward Experience</title>

  <!-- A-Frame + MindAR + Confetti -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body,html{
      margin:0;
      height:100%;
      font-family:'Poppins',sans-serif;
      background:transparent;
      overflow:hidden;
    }
    #status{
      position:fixed;
      bottom:15px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.55);
      color:#fff;
      padding:8px 14px;
      border-radius:10px;
      font-size:14px;
      z-index:9999;
      animation:fadeIn 0.5s ease;
    }

    #overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(10px) brightness(0.8);
      background:rgba(0,0,0,0.6);
      z-index:10000;
      animation:fadeIn 0.5s ease;
    }

    #card{
      width:360px;
      max-width:92%;
      background:rgba(255,255,255,0.9);
      border-radius:22px;
      box-shadow:0 8px 35px rgba(0,0,0,0.4);
      padding:24px;
      text-align:center;
      position:relative;
      backdrop-filter:blur(12px);
      animation:popUp 0.5s ease;
    }

    #card h2{
      margin:0 0 10px;
      font-size:22px;
      color:#111;
    }
    #card p.sub{
      margin:0 0 14px;
      font-size:14px;
      color:#555;
    }
    #scratchCanvas{
      width:100%;
      height:150px;
      border-radius:14px;
      display:block;
      cursor:crosshair;
      box-shadow:inset 0 0 15px rgba(0,0,0,0.3);
    }
    #revealedDiscount{
      display:none;
      font-size:20px;
      color:#0a0;
      font-weight:600;
      margin-top:14px;
      letter-spacing:0.5px;
    }
    #closeBtn{
      position:absolute;
      top:10px;
      right:12px;
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      color:#333;
    }

    #toast{
      position:fixed;
      top:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:#fff;
      padding:12px 18px;
      border-radius:12px;
      display:none;
      font-size:14px;
      z-index:10001;
      animation:fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from{opacity:0;} to{opacity:1;}
    }
    @keyframes popUp {
      0%{transform:scale(0.9);opacity:0;}
      100%{transform:scale(1);opacity:1;}
    }
  </style>
</head>
<body>
  <div id="status">üì∑ Initializing camera...</div>

  <div id="overlay">
    <div id="card">
      <button id="closeBtn">‚úï</button>
      <h2>üéÅ You‚Äôve Earned a Reward!</h2>
      <p class="sub">Scratch below to see what you‚Äôve unlocked</p>
      <canvas id="scratchCanvas"></canvas>
      <div id="revealedDiscount"></div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- AR Scene -->
  <a-scene
  mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
  embedded
  color-space="sRGB"
  renderer="colorManagement: true, physicallyCorrectLights"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false"
>
  <a-assets>
    <!-- autoplay muted ensures smooth auto playback -->
    <video
      id="myVideo"
      src="thank_you.mp4"
      playsinline
      preload="auto"
      crossorigin="anonymous"
      loop="false"
      muted="true"
    ></video>
  </a-assets>

  <a-camera look-controls="enabled: false"></a-camera>

  <a-entity mindar-image-target="targetIndex: 0">
    <a-video
      id="videoPlane"
      src="#myVideo"
      width="1"
      height="0.56"
      position="0 0 0"
      rotation="0 0 0"
      material="shader: flat; transparent: true; opacity: 0"
      visible="false"
    ></a-video>
  </a-entity>
</a-scene>
  
<script>
const params = new URLSearchParams(window.location.search);
const discount = decodeURIComponent(params.get('discount') || '');
const isFirst = params.get('isFirst') === 'true';

const status = document.getElementById('status');
const video = document.getElementById('myVideo');
const plane = document.getElementById('videoPlane');
const overlay = document.getElementById('overlay');
const scratchCanvas = document.getElementById('scratchCanvas');
const closeBtn = document.getElementById('closeBtn');
const toast = document.getElementById('toast');
const revealedDiscount = document.getElementById('revealedDiscount');

// ----------- AR Handling -----------
document.querySelector('a-scene').addEventListener('arReady', () => {
  status.innerText = '‚úÖ Ready ‚Äî point camera at your card';
});
document.querySelector('a-scene').addEventListener('targetFound', async () => {
  status.innerText = 'üé¨ Target found ‚Äî video playing';
  plane.setAttribute('visible', true);
  plane.setAttribute('material', 'shader:flat; opacity:1;');
  try { await video.play(); } catch(e) {}
});
document.querySelector('a-scene').addEventListener('targetLost', () => {
  status.innerText = 'üì∑ Hold steady to keep AR visible';
  video.pause();
  plane.setAttribute('material', 'shader:flat; opacity:0;');
  plane.setAttribute('visible', false);
});

// ----------- Scratch System -----------
let ctx, scratching = false;

function initScratch() {
  const rect = scratchCanvas.getBoundingClientRect();
  scratchCanvas.width = rect.width * devicePixelRatio;
  scratchCanvas.height = 150 * devicePixelRatio;
  ctx = scratchCanvas.getContext('2d');

  // Metallic gradient look
  const grad = ctx.createLinearGradient(0, 0, scratchCanvas.width, scratchCanvas.height);
  grad.addColorStop(0, '#a6a6a6');
  grad.addColorStop(0.5, '#d9d9d9');
  grad.addColorStop(1, '#a6a6a6');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);

  ctx.font = `${28 * devicePixelRatio}px Poppins`;
  ctx.fillStyle = 'rgba(0,0,0,0.75)';
  ctx.textAlign = 'center';
  ctx.fillText('Scratch Here', scratchCanvas.width / 2, scratchCanvas.height / 2 + 10 * devicePixelRatio);

  ctx.globalCompositeOperation = 'destination-out';
}

function scratchAt(x, y) {
  // Smooth pressure effect
  ctx.beginPath();
  ctx.arc(x * devicePixelRatio, y * devicePixelRatio, 25 * devicePixelRatio, 0, Math.PI * 2);
  ctx.fill();
}

scratchCanvas.addEventListener('pointerdown', () => scratching = true);
scratchCanvas.addEventListener('pointerup', () => scratching = false);
scratchCanvas.addEventListener('pointermove', e => {
  if (!scratching) return;
  const rect = scratchCanvas.getBoundingClientRect();
  scratchAt(e.clientX - rect.left, e.clientY - rect.top);
});
closeBtn.addEventListener('click', () => overlay.style.display = 'none');

// ----------- Video + Overlay -----------
video.addEventListener('ended', () => {
  // Show overlay ONLY for first scan
  if (isFirst) {
    overlay.style.display = 'flex';
    setTimeout(() => initScratch(), 150);
  }
});

// ----------- Scratch Complete -----------
scratchCanvas.addEventListener('pointerup', () => {
  confetti({ particleCount: 120, spread: 80, origin: { y: 0.7 } });
  revealedDiscount.style.display = 'block';
  revealedDiscount.textContent = discount
    ? `üéâ You unlocked ${discount}!`
    : `üéä Reward unlocked!`;
  showToast(`‚ú® ${discount || 'Reward'} revealed!`);
});

// ----------- Toast -----------
function showToast(msg) {
  toast.innerText = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 2500);
}
</script>
</body>
</html>

