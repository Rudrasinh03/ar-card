<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AR Reward ‚Äî Premium Experience</title>

  <!-- A-Frame + MindAR + Confetti -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body,html{
      margin:0;
      height:100%;
      font-family:'Poppins',sans-serif;
      background:#000;
      overflow:hidden;
    }

    #status{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.6);
      color:#ffd700;
      padding:10px 18px;
      border:1px solid rgba(255,215,0,0.4);
      border-radius:12px;
      font-size:14px;
      font-weight:500;
      box-shadow:0 0 15px rgba(255,215,0,0.2);
      backdrop-filter:blur(6px);
      z-index:9999;
      animation:fadeIn 0.5s ease;
    }

    #overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.85);
      z-index:10000;
      backdrop-filter:blur(12px);
      animation:fadeIn 0.5s ease;
    }

    #card{
      width:340px;
      max-width:92%;
      background:rgba(25,25,25,0.85);
      border-radius:24px;
      border:1px solid rgba(255,215,0,0.2);
      box-shadow:0 0 25px rgba(255,215,0,0.15);
      padding:26px;
      text-align:center;
      color:#fff;
      animation:popUp 0.4s ease;
      position:relative;
    }

    #card h2{
      margin:0 0 8px;
      font-size:22px;
      color:#ffd700;
      font-weight:600;
      letter-spacing:0.3px;
    }
    #card p.sub{
      margin:0 0 16px;
      font-size:14px;
      color:#ccc;
    }

    #scratchCanvas{
      width:100%;
      height:150px;
      border-radius:16px;
      display:block;
      cursor:crosshair;
      background:linear-gradient(135deg,#222,#111);
      box-shadow:inset 0 0 20px rgba(255,215,0,0.2);
    }

    #revealedDiscount{
      display:none;
      font-size:22px;
      color:#ffd700;
      font-weight:600;
      margin-top:18px;
      letter-spacing:0.6px;
      text-shadow:0 0 12px rgba(255,215,0,0.5);
    }

    #closeBtn{
      position:absolute;
      top:10px;
      right:14px;
      background:none;
      border:none;
      font-size:22px;
      cursor:pointer;
      color:#ffd700;
    }

    #toast{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:#ffd700;
      padding:12px 20px;
      border-radius:14px;
      font-size:15px;
      border:1px solid rgba(255,215,0,0.3);
      display:none;
      z-index:10001;
      box-shadow:0 0 10px rgba(255,215,0,0.25);
    }

    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @keyframes popUp { 0%{transform:scale(0.9);opacity:0;} 100%{transform:scale(1);opacity:1;} }
  </style>
</head>
<body>
  <div id="status">üì∑ Initializing AR camera...</div>

  <div id="overlay">
    <div id="card">
      <button id="closeBtn">‚úï</button>
      <h2>üéÅ Premium Reward Unlocked!</h2>
      <p class="sub">Scratch the card below to reveal your discount</p>
      <canvas id="scratchCanvas"></canvas>
      <div id="revealedDiscount"></div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- AR Scene -->
  <a-scene
    mindar-image="imageTargetSrc: targets (1).mind; autoStart: true;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <video
        id="myVideo"
        src="thank_you.mp4"
        playsinline
        preload="auto"
        crossorigin="anonymous"
        muted
      ></video>
    </a-assets>

    <a-camera look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-video
        id="videoPlane"
        src="#myVideo"
        width="1"
        height="0.56"
        position="0 0 0"
        rotation="0 0 0"
        visible="false"
        material="shader:flat; transparent:true; opacity:0;"
      ></a-video>
    </a-entity>
  </a-scene>

  <script>
  const params = new URLSearchParams(window.location.search);
  const discount = decodeURIComponent(params.get('discount') || '');
  const isFirst = params.get('isFirst') === 'true';

  const status = document.getElementById('status');
  const video = document.getElementById('myVideo');
  const plane = document.getElementById('videoPlane');
  const overlay = document.getElementById('overlay');
  const scratchCanvas = document.getElementById('scratchCanvas');
  const closeBtn = document.getElementById('closeBtn');
  const toast = document.getElementById('toast');
  const revealedDiscount = document.getElementById('revealedDiscount');

  // --- AR Events ---
  document.querySelector('a-scene').addEventListener('arReady', () => {
    status.innerText = '‚úÖ AR Ready ‚Äî Point your camera at the target card';
  });

  document.querySelector('a-scene').addEventListener('targetFound', async () => {
    status.innerText = 'üé¨ Target found ‚Äî playing your thank-you video';
    plane.setAttribute('visible', true);
    plane.setAttribute('material', 'shader:flat; opacity:1;');
    try { await video.play(); } catch(e) { console.warn('Video play failed', e); }
  });

  document.querySelector('a-scene').addEventListener('targetLost', () => {
    status.innerText = 'üì∑ Keep the card in view';
    video.pause();
    plane.setAttribute('visible', false);
  });

  // --- Scratch System ---
  let ctx, scratching = false;
  function initScratch(){
    const rect = scratchCanvas.getBoundingClientRect();
    scratchCanvas.width = rect.width * devicePixelRatio;
    scratchCanvas.height = 150 * devicePixelRatio;
    ctx = scratchCanvas.getContext('2d');

    const grad = ctx.createLinearGradient(0,0,scratchCanvas.width,scratchCanvas.height);
    grad.addColorStop(0,'#666');
    grad.addColorStop(0.5,'#999');
    grad.addColorStop(1,'#666');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,scratchCanvas.width,scratchCanvas.height);
    ctx.font = `${28*devicePixelRatio}px Poppins`;
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.textAlign='center';
    ctx.fillText('Scratch Here',scratchCanvas.width/2,scratchCanvas.height/2+10*devicePixelRatio);
    ctx.globalCompositeOperation='destination-out';
  }

  function scratchAt(x,y){
    ctx.beginPath();
    ctx.arc(x*devicePixelRatio,y*devicePixelRatio,25*devicePixelRatio,0,Math.PI*2);
    ctx.fill();
  }

  scratchCanvas.addEventListener('pointerdown',()=>scratching=true);
  scratchCanvas.addEventListener('pointerup',()=>{
    scratching=false;
    // reveal discount fully on release
    confetti({particleCount:150,spread:90,origin:{y:0.7}});
    revealedDiscount.style.display='block';
    revealedDiscount.textContent = discount ? `üéâ You got ${discount} OFF!` : `üéä Reward Unlocked!`;
    showToast(`‚ú® ${discount || 'Reward'} revealed!`);
  });
  scratchCanvas.addEventListener('pointermove',e=>{
    if(!scratching)return;
    const rect = scratchCanvas.getBoundingClientRect();
    scratchAt(e.clientX-rect.left,e.clientY-rect.top);
  });
  closeBtn.addEventListener('click',()=>{
    overlay.style.display='none';
    document.querySelector('a-scene').style.pointerEvents='auto';
  });

  // --- Video End -> Show Scratch Card ---
  video.addEventListener('ended',()=>{
    if(isFirst){
      overlay.style.display='flex';
      document.querySelector('a-scene').style.pointerEvents='none'; // stop camera shake
      setTimeout(()=>initScratch(),200);
    }
  });

  // --- Toast ---
  function showToast(msg){
    toast.innerText=msg;
    toast.style.display='block';
    setTimeout(()=>toast.style.display='none',2500);
  }
  </script>
</body>
</html>

